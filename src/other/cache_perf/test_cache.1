#!/usr/bin/env bash

CMD=$1
shift

IDS=$1
shift

export TB_TIMER_NAME=`echo $CMD $@ | sed 's/-//g' | tr '\t' '_' | sed 's/ /_/g'`

echo "---> Running $TB_TIMER_NAME $CMD $IDS $@" >&2

export TB_TIMER_ON=true
echo "PERF ================================================================================"
echo "PERF $CMD $IDS $@"

# Do not edit to make the path a variable - dangerous
rm -fR ~/Data/trueblocks/v0.70.0/cache/mainnet
mkdir -p ~/Data/trueblocks/v0.70.0/cache/mainnet/monitors/
cp -pR monitors/* ~/Data/trueblocks/v0.70.0/cache/mainnet/monitors/
chifra $CMD $IDS $@ --cache --fmt json >one/$TB_TIMER_NAME && \
   cat one/$TB_TIMER_NAME | grep PERF && \
   cat one/$TB_TIMER_NAME | sed 's/PERF/|PERF/' | tr '|' '\n' | grep -v PERF >x && cat x >one/$TB_TIMER_NAME && rm -f x && \
   chifra $CMD $IDS $@ --fmt json >two/$TB_TIMER_NAME && \
   cat two/$TB_TIMER_NAME | grep PERF && \
   cat two/$TB_TIMER_NAME | sed 's/PERF/|PERF/' | tr '|' '\n' | grep -v PERF >x && cat x >two/$TB_TIMER_NAME && rm -f x && \
   sleep 1 && \
   find ~/Data/trueblocks/v0.70.0/cache/mainnet -type f | wc -l | sed 's/^.* //' | sed 's/^/PERF nItems in cache: /' && \
   export TB_TIMER_ON=false && \
   chifra $CMD $IDS --decache  && \
   diff one/$TB_TIMER_NAME two/$TB_TIMER_NAME

echo "--------------------------------------------------------------------------------"
